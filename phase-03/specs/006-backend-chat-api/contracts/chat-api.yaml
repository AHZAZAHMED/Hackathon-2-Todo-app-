openapi: 3.0.3
info:
  title: Backend Chat API
  description: |
    Conversational API for task management using OpenAI Agents SDK with Gemini 2.0 Flash.

    The API authenticates users via Better Auth JWT, manages conversation history in PostgreSQL,
    and orchestrates an AI agent that can invoke MCP tools to perform task operations.
  version: 1.0.0
  contact:
    name: Hackathon II Phase-3 Team

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: chat
    description: Chat conversation endpoints

paths:
  /api/chat:
    post:
      tags:
        - chat
      summary: Send chat message to AI agent
      description: |
        Sends a user message to the AI agent and receives a response.

        **Flow**:
        1. Verify JWT and extract user_id
        2. Get or create conversation
        3. Load conversation history (last 2000 tokens)
        4. Store user message
        5. Invoke AI agent with MCP tools
        6. Store assistant response
        7. Return response with tool invocation details

        **Stateless**: All conversation state persists in database.
      operationId: sendChatMessage
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              newConversation:
                summary: New conversation (no conversation_id)
                value:
                  message: "Add a task to buy milk"
              existingConversation:
                summary: Existing conversation (with conversation_id)
                value:
                  message: "Mark it as complete"
                  conversation_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successful response from AI agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                withToolCall:
                  summary: Response with tool invocation
                  value:
                    conversation_id: "550e8400-e29b-41d4-a716-446655440000"
                    response: "I've added a task to buy milk to your todo list."
                    tool_calls:
                      - tool: "add_task"
                        arguments:
                          title: "Buy milk"
                          description: ""
                        result:
                          id: 123
                          title: "Buy milk"
                          description: ""
                          completed: false
                          created_at: "2026-02-08T10:30:00Z"
                          updated_at: "2026-02-08T10:30:00Z"
                withoutToolCall:
                  summary: Response without tool invocation
                  value:
                    conversation_id: "550e8400-e29b-41d4-a716-446655440000"
                    response: "Hello! I'm your task management assistant. How can I help you today?"
                    tool_calls: []
        '401':
          description: Authentication failed (missing or invalid JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Authentication failed. Please log in again."
        '422':
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingMessage:
                  summary: Missing message field
                  value:
                    error: "Invalid request. Message is required."
                messageTooLong:
                  summary: Message exceeds length limit
                  value:
                    error: "Invalid request. Message must be less than 10,000 characters."
        '500':
          description: Internal server error (MCP tool failure, unexpected error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unable to process your request. Please try again."
        '503':
          description: AI service unavailable (Gemini API down)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "AI service temporarily unavailable. Please try again in a moment."
        '504':
          description: Request timeout (exceeded 5 seconds)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Request took too long to process. Please try again with a simpler message."

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Better Auth JWT token obtained from authentication endpoints.

        The token contains user_id in claims, which is extracted server-side
        for user isolation and MCP tool invocation.

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 10000
          description: User's chat message
          example: "Add a task to buy milk"
        conversation_id:
          type: string
          format: uuid
          description: |
            Optional UUID of existing conversation.
            If omitted, backend auto-creates new conversation.
          example: "550e8400-e29b-41d4-a716-446655440000"

    ChatResponse:
      type: object
      required:
        - conversation_id
        - response
        - tool_calls
      properties:
        conversation_id:
          type: string
          format: uuid
          description: UUID of conversation (newly created or existing)
          example: "550e8400-e29b-41d4-a716-446655440000"
        response:
          type: string
          description: AI agent's response message
          example: "I've added a task to buy milk to your todo list."
        tool_calls:
          type: array
          description: List of MCP tools invoked during request (empty if no tools used)
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      required:
        - tool
        - arguments
        - result
      properties:
        tool:
          type: string
          enum:
            - add_task
            - list_tasks
            - complete_task
            - delete_task
            - update_task
          description: Name of MCP tool invoked
          example: "add_task"
        arguments:
          type: object
          description: Arguments passed to the tool
          example:
            title: "Buy milk"
            description: ""
        result:
          type: object
          description: Result returned by the tool (structure varies by tool)
          example:
            id: 123
            title: "Buy milk"
            completed: false

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: User-friendly error message (no stack traces or sensitive data)
          example: "Authentication failed. Please log in again."

  examples:
    AddTaskRequest:
      summary: Add a new task
      value:
        message: "Add a task to buy milk"

    ListTasksRequest:
      summary: List all tasks
      value:
        message: "Show me my tasks"
        conversation_id: "550e8400-e29b-41d4-a716-446655440000"

    CompleteTaskRequest:
      summary: Mark task as complete
      value:
        message: "Mark the milk task as done"
        conversation_id: "550e8400-e29b-41d4-a716-446655440000"

    DeleteTaskRequest:
      summary: Delete a task
      value:
        message: "Delete the milk task"
        conversation_id: "550e8400-e29b-41d4-a716-446655440000"

    UpdateTaskRequest:
      summary: Update task title
      value:
        message: "Change the milk task to buy bread"
        conversation_id: "550e8400-e29b-41d4-a716-446655440000"
