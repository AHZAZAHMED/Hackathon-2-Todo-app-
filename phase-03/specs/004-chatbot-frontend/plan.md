# Implementation Plan: Phase-3 Chatbot Frontend

**Branch**: `004-chatbot-frontend` | **Date**: 2026-02-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-chatbot-frontend/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following the approved specification.

## Summary

Build a production-ready ChatKit-based frontend that provides a conversational interface for managing todos via the Phase-3 chat API. The frontend integrates with Better Auth JWT and communicates exclusively with POST /api/chat. A floating launcher icon provides convenient access to the chatbot from any authenticated page.

**Primary Requirements**:
- OpenAI ChatKit UI integration for chat interface
- Floating launcher icon fixed at bottom-right corner of all authenticated pages
- JWT-based authentication with automatic token attachment
- Chat interface with open/close/minimize functionality
- Conversation history loading and display
- Responsive design for desktop and mobile
- Error handling with user-friendly messages

**Technical Approach**:
- Extend existing Phase-2 Next.js 16+ frontend with new chat page and floating launcher component
- Install and configure OpenAI ChatKit library
- Create centralized chat API client that extends existing API client infrastructure
- Implement floating launcher icon with z-index management
- Use React state management for chat open/closed/minimized states
- Persist chat state across page navigations using session storage or React context
- Configure environment variables for API base URL and OpenAI domain allowlist

## Technical Context

**Language/Version**: TypeScript 5.x with strict mode (existing Phase-2 configuration)
**Primary Dependencies**:
- Next.js 16+ (existing)
- React 19+ (existing)
- OpenAI ChatKit (to be installed)
- Tailwind CSS (existing)
- Better Auth JWT (existing Phase-2)

**Storage**: N/A (frontend only - conversation state managed by backend)
**Testing**: Playwright for browser-based validation (existing Phase-2 infrastructure)
**Target Platform**: Web browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+, iOS Safari 14+, Android Chrome 90+)
**Project Type**: Web application (frontend extension of existing Phase-2)
**Performance Goals**:
- Chat interface renders in <1 second
- Message send/receive latency <5 seconds (95th percentile)
- Conversation history with 100+ messages loads in <3 seconds
- Floating icon visible within 500ms of page load
- Chat opens within 300ms of icon click (95th percentile)

**Constraints**:
- Frontend-only scope (no backend, AI, or MCP logic)
- Must use official OpenAI ChatKit library
- Must communicate exclusively with POST /api/chat
- JWT-only authentication (no manual user_id)
- Stateless frontend (all conversation state from backend)
- No WebSockets (standard HTTP requests only)
- Must integrate with existing Phase-2 Next.js App Router architecture

**Scale/Scope**:
- Single chat interface accessible from all authenticated pages
- Support 50+ messages per conversation without performance degradation
- Responsive design for screen sizes down to 375px width
- Single conversation per user (no conversation switching)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase-2 Principles (Inherited)

✅ **Principle I: Spec-Driven Development**
- Status: COMPLIANT
- Evidence: Implementation follows approved specification from PHR-003 and PHR-004
- No deviations permitted

✅ **Principle II: JWT-Only Identity**
- Status: COMPLIANT
- Evidence: Frontend uses existing Better Auth JWT, never sends user_id manually
- Chat API client automatically attaches JWT via Authorization header

✅ **Principle III: Database-Backed Persistence**
- Status: COMPLIANT (N/A for frontend)
- Evidence: Frontend does not manage persistence - all conversation state comes from backend
- No in-memory conversation storage on frontend

✅ **Principle IV: Production-Grade Architecture**
- Status: COMPLIANT
- Evidence: TypeScript strict mode, Tailwind CSS official config, environment variables, centralized API client, error handling

✅ **Principle V: Root-Cause Engineering**
- Status: COMPLIANT
- Evidence: Implementation addresses requirements directly, no workarounds

✅ **Principle VI: Clear Separation of Layers**
- Status: COMPLIANT
- Evidence: Frontend-only scope, no backend/AI/MCP logic, clear API contract with POST /api/chat

### Phase-3 Principles (Applicable)

✅ **Principle VII: MCP-Only Database Mutations**
- Status: N/A (frontend does not access database)
- Evidence: Frontend communicates only with chat endpoint

✅ **Principle VIII: Stateless Backend Architecture**
- Status: COMPLIANT (frontend perspective)
- Evidence: Frontend does not maintain conversation state, fetches from backend on each load

✅ **Principle IX: AI Agent Orchestration**
- Status: N/A (frontend does not implement agent logic)
- Evidence: Frontend sends messages to chat endpoint, backend handles agent orchestration

### Quality Gates

**Frontend Gates**:
- [ ] OpenAI ChatKit installed and configured
- [ ] Chat page renders without errors
- [ ] Floating launcher icon visible on all authenticated pages
- [ ] Chat interface opens/closes/minimizes correctly
- [ ] JWT attached to chat requests automatically
- [ ] Messages sent and received successfully
- [ ] Conversation history loads correctly
- [ ] Loading states handled
- [ ] Error states handled
- [ ] Responsive design works on mobile
- [ ] TypeScript compiles with strict mode
- [ ] No console errors in browser

**Integration Gates**:
- [ ] Chat flow works end-to-end (send message → receive response)
- [ ] JWT authentication enforced (unauthenticated users redirected)
- [ ] Conversation persists across page refreshes
- [ ] Chat state persists across page navigations
- [ ] Floating icon does not obstruct page content
- [ ] Phase-2 functionality remains intact

### Constitution Compliance Summary

**Status**: ✅ FULLY COMPLIANT

All applicable constitution principles are satisfied. No violations require justification.

## Project Structure

### Documentation (this feature)

```text
specs/004-chatbot-frontend/
├── spec.md              # Feature specification (approved)
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (to be generated)
├── data-model.md        # Phase 1 output (to be generated)
├── quickstart.md        # Phase 1 output (to be generated)
├── contracts/           # Phase 1 output (to be generated)
│   └── chat-api.yaml    # OpenAPI spec for POST /api/chat
├── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
└── checklists/
    └── requirements.md  # Specification quality checklist (existing)
```

### Source Code (repository root)

```text
frontend/
├── CLAUDE.md                          # Frontend-specific rules (existing Phase-2)
├── app/
│   ├── (auth)/                        # Existing Phase-2 auth routes
│   ├── (dashboard)/                   # Existing Phase-2 dashboard routes
│   └── chat/                          # NEW: Chat page route
│       └── page.tsx                   # Chat page component
├── components/
│   ├── ui/                            # Existing Phase-2 UI components
│   ├── chat/                          # NEW: Chat-specific components
│   │   ├── ChatInterface.tsx          # Main chat interface component
│   │   ├── ChatMessage.tsx            # Individual message component
│   │   ├── ChatInput.tsx              # Message input component
│   │   ├── ChatHistory.tsx            # Conversation history component
│   │   └── FloatingChatLauncher.tsx   # Floating launcher icon component
│   └── layout/
│       └── FloatingChatProvider.tsx   # NEW: Global chat state provider
├── lib/
│   ├── api-client.ts                  # Existing Phase-2 centralized API client
│   ├── chat-api-client.ts             # NEW: Chat-specific API client
│   └── hooks/
│       ├── useChat.ts                 # NEW: Chat state management hook
│       └── useChatHistory.ts          # NEW: Conversation history hook
├── types/
│   └── chat.ts                        # NEW: Chat-related TypeScript types
└── .env.example                       # Updated with NEXT_PUBLIC_OPENAI_DOMAIN_KEY

backend/                               # Existing Phase-2 (no changes in this feature)
```

**Structure Decision**:

This feature extends the existing Phase-2 Next.js frontend with new chat-related components and pages. The structure follows Next.js 16+ App Router conventions:

1. **New `/chat` route**: Dedicated page for full chat interface (optional - may not be needed if floating launcher is primary access method)
2. **New `/components/chat/` directory**: All chat-specific UI components
3. **New `FloatingChatProvider.tsx`**: Global provider component that renders floating launcher icon on all authenticated pages
4. **New `/lib/chat-api-client.ts`**: Extends existing API client infrastructure with chat-specific methods
5. **New `/lib/hooks/`**: Custom React hooks for chat state management
6. **New `/types/chat.ts`**: TypeScript type definitions for chat messages, conversation state

The floating launcher icon is implemented as a global component that:
- Renders on all authenticated pages via layout component or provider
- Manages chat open/closed/minimized state
- Renders chat interface as modal or slide-in panel when opened
- Persists state across page navigations using React context

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. This section is not applicable.

## Phase 0: Research & Technology Validation

**Objective**: Resolve all technical unknowns and validate technology choices before design phase.

### Research Tasks

1. **OpenAI ChatKit Integration**
   - Research: Official OpenAI ChatKit documentation at https://platform.openai.com/docs/guides/chatkit
   - Validate: Compatibility with Next.js 16+ and React 19+
   - Investigate: Configuration requirements for domain allowlist (NEXT_PUBLIC_OPENAI_DOMAIN_KEY)
   - Document: Installation steps, configuration options, API surface, authentication setup

2. **ChatKit UI Patterns**
   - Research: Best practices for integrating ChatKit with Next.js App Router
   - Investigate: ChatKit component structure (message display, input handling, streaming support)
   - Document: Component integration patterns, styling customization with Tailwind CSS, theming options

3. **Floating Launcher Implementation with ChatKit**
   - Research: Best practices for wrapping ChatKit in floating UI elements
   - Investigate: Z-index management strategies to avoid conflicts with existing UI
   - Investigate: State persistence across page navigations (React context for launcher UI state)
   - Document: Implementation patterns for custom wrapper with ChatKit inside, z-index hierarchy

4. **Chat State Management with ChatKit**
   - Research: How ChatKit manages conversation state internally
   - Investigate: React patterns for managing launcher open/closed/minimized states (separate from ChatKit state)
   - Document: Recommended approach (React context for UI state, ChatKit for message state)

5. **JWT Integration with ChatKit**
   - Research: How to configure ChatKit with JWT authentication
   - Validate: JWT token passing to ChatKit for API requests
   - Document: ChatKit authentication configuration pattern

6. **Responsive Design with ChatKit**
   - Research: ChatKit responsive design capabilities
   - Investigate: Responsive positioning for floating launcher wrapper
   - Document: Breakpoint strategy, mobile-specific considerations, ChatKit container sizing

### Research Output

**Deliverable**: `research.md` containing:
- Decision: Technology/pattern chosen (OpenAI ChatKit confirmed)
- Rationale: Why ChatKit is suitable for this project
- Implementation guidance: ChatKit installation, configuration, wrapper patterns
- Key steps and gotchas for ChatKit integration

**Success Criteria**:
- All "NEEDS CLARIFICATION" items from Technical Context resolved
- OpenAI ChatKit compatibility confirmed (exists and works with Next.js 16+)
- Floating launcher wrapper pattern defined (custom wrapper with ChatKit inside)
- State management approach selected (React context for UI, ChatKit for messages)
- No blocking technical unknowns remain

## Phase 1: Design & Contracts

**Prerequisites**: `research.md` complete with all technical unknowns resolved

### 1.1 Data Model

**Objective**: Define frontend data structures for chat functionality.

**Deliverable**: `data-model.md`

**Entities**:

1. **ChatMessage**
   - Fields: id, role (user|assistant), content, timestamp, status (pending|sent|delivered|error)
   - Validation: content non-empty, role must be user or assistant
   - State transitions: pending → sent → delivered OR pending → error

2. **Conversation**
   - Fields: id, messages (ChatMessage[]), status (active|loading|error)
   - Validation: messages array ordered chronologically
   - State transitions: active ↔ loading, active → error

3. **ChatUIState**
   - Fields: isOpen (boolean), isMinimized (boolean), activeConversationId (string|null)
   - Validation: cannot be both open and minimized
   - State transitions: closed → open, open → minimized, minimized → open, open → closed

**Relationships**:
- Conversation contains many ChatMessages
- ChatUIState references one active Conversation

### 1.2 API Contracts

**Objective**: Define contract for POST /api/chat endpoint.

**Deliverable**: `contracts/chat-api.yaml` (OpenAPI 3.0 specification)

**Endpoint**: POST /api/chat

**Request**:
```yaml
headers:
  Authorization: Bearer {JWT}
  Content-Type: application/json

body:
  message: string (required, non-empty)
```

**Response (Success - 200)**:
```yaml
body:
  response: string (assistant message content)
  conversation_id: string (conversation identifier)
  timestamp: string (ISO 8601)
```

**Response (Error - 401)**:
```yaml
body:
  error: "Unauthorized"
  message: "Invalid or missing JWT token"
```

**Response (Error - 422)**:
```yaml
body:
  error: "Validation Error"
  message: "Message cannot be empty"
```

**Response (Error - 500)**:
```yaml
body:
  error: "Internal Server Error"
  message: "Unable to process request"
```

**Additional Endpoints** (if needed):

GET /api/chat/history
- Fetch conversation history for authenticated user
- Returns array of ChatMessage objects

### 1.3 Component Architecture

**Objective**: Define component hierarchy and responsibilities.

**Deliverable**: Component architecture documented in `quickstart.md`

**Component Tree**:
```
App Layout (existing Phase-2)
└── FloatingChatProvider (NEW)
    ├── FloatingChatLauncher (NEW)
    │   └── ChatInterface (NEW - rendered when open)
    │       ├── ChatHeader (NEW)
    │       ├── ChatHistory (NEW)
    │       │   └── ChatMessage[] (NEW)
    │       └── ChatInput (NEW)
    └── {children} (existing page content)
```

**Component Responsibilities**:

1. **FloatingChatProvider**
   - Manages global chat state (open/closed/minimized)
   - Provides chat context to all child components
   - Persists state across page navigations
   - Renders on all authenticated pages

2. **FloatingChatLauncher**
   - Renders floating icon at bottom-right corner
   - Handles click to open chat interface
   - Shows unread message indicator (if applicable)
   - Manages z-index to avoid content obstruction

3. **ChatInterface**
   - Main chat UI container (modal or slide-in panel)
   - Renders when chat is open
   - Handles close and minimize actions
   - Manages chat-specific state (loading, error)

4. **ChatHeader**
   - Displays chat title
   - Provides close and minimize buttons
   - Shows connection status (if applicable)

5. **ChatHistory**
   - Displays conversation messages in chronological order
   - Handles auto-scroll to latest message
   - Shows loading indicator while fetching history
   - Renders empty state for new conversations

6. **ChatMessage**
   - Renders individual message (user or assistant)
   - Applies visual distinction based on role
   - Shows timestamp and status
   - Handles error state display

7. **ChatInput**
   - Text input field for user messages
   - Send button
   - Prevents empty message submission
   - Shows loading state while waiting for response
   - Clears input after successful send

### 1.4 State Management

**Objective**: Define state management strategy for chat functionality.

**Approach**: React Context API with custom hooks

**Context Structure**:
```typescript
ChatContext {
  // UI State
  isOpen: boolean
  isMinimized: boolean

  // Conversation State
  messages: ChatMessage[]
  isLoading: boolean
  error: string | null

  // Actions
  openChat: () => void
  closeChat: () => void
  minimizeChat: () => void
  sendMessage: (content: string) => Promise<void>
  loadHistory: () => Promise<void>
}
```

**Custom Hooks**:
- `useChat()`: Access chat context and actions
- `useChatHistory()`: Fetch and manage conversation history
- `useChatUI()`: Manage UI state (open/closed/minimized)

### 1.5 Quickstart Guide

**Objective**: Provide implementation quickstart for developers.

**Deliverable**: `quickstart.md`

**Contents**:
1. Installation steps (OpenAI ChatKit, dependencies)
2. Environment variable configuration
3. Component integration guide
4. API client setup
5. Testing approach
6. Common issues and solutions

### 1.6 Agent Context Update

**Objective**: Update agent-specific context file with new technologies.

**Action**: Run `.specify/scripts/powershell/update-agent-context.ps1 -AgentType claude`

**Expected Updates**:
- Add OpenAI ChatKit to technology stack
- Add chat-specific component patterns
- Add floating launcher implementation notes
- Preserve existing Phase-2 context

## Phase 2: Task Breakdown

**Note**: Phase 2 (task generation) is handled by the `/sp.tasks` command, NOT by `/sp.plan`.

This plan stops after Phase 1 design artifacts are generated. The user must run `/sp.tasks` to generate the task breakdown.

## Validation Criteria

### Phase 0 Validation (Research Complete)
- [ ] `research.md` exists and contains all required sections
- [ ] OpenAI ChatKit compatibility confirmed
- [ ] Floating launcher implementation pattern documented
- [ ] State management approach selected
- [ ] No unresolved technical unknowns

### Phase 1 Validation (Design Complete)
- [ ] `data-model.md` exists with all entities defined
- [ ] `contracts/chat-api.yaml` exists with complete OpenAPI spec
- [ ] `quickstart.md` exists with implementation guide
- [ ] Component architecture documented
- [ ] Agent context updated successfully
- [ ] Constitution Check re-evaluated (still compliant)

### Implementation Readiness
- [ ] All design artifacts generated
- [ ] No blocking dependencies
- [ ] Clear implementation path defined
- [ ] Ready for `/sp.tasks` command

## Agent Assignment

**Primary Agent**: `senior-next.js-developer`
- Responsible for: Next.js 16+ App Router integration, React component architecture, TypeScript implementation

**Supporting Agents**:
- `implementation-validator-playwright`: Browser-based validation after implementation
- `integration-testing-engineer`: End-to-end flow validation

**Agent Invocation Strategy**:
1. Use `senior-next.js-developer` for all frontend implementation tasks
2. Use `implementation-validator-playwright` after each major component is implemented
3. Use `integration-testing-engineer` for final end-to-end validation

## Phase Compliance Statement

This implementation plan complies with all Phase-3 constitution principles:

✅ **Spec-Driven Development**: Plan follows approved specification (PHR-003, PHR-004)
✅ **JWT-Only Identity**: Frontend uses existing Better Auth JWT, no manual user_id
✅ **Clear Separation of Layers**: Frontend-only scope, no backend/AI/MCP logic
✅ **Production-Grade Architecture**: TypeScript strict mode, centralized API client, error handling
✅ **Stateless Frontend**: No conversation state maintained on frontend

**Phase-2 Foundation**: This feature extends existing Phase-2 Next.js frontend without breaking changes.

**Phase-3 Integration**: Frontend communicates exclusively with POST /api/chat endpoint (backend handles agent orchestration and MCP tool invocation).

---

**Plan Status**: ✅ READY FOR PHASE 0 RESEARCH

**Next Command**: Continue with Phase 0 research task execution (automated by this command)
